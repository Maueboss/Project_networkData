---
title: "Descriptive Statistics"
author: "Giuseppe Specioso"
date: "2024-06-10"
output: pdf_document
---

```{r}
library(graphlayouts)
library(ggforce)
library(dplyr)
library(ggplot2)
library(igraph)
library(tidyverse)
library(ggraph)
library(ggrepel)
```


```{r}
# Import the data
# Overall dolphin social network
overall_dolphins <- read.table("mammalia-dolphin-florida-overall.edges")
# Forage dolphins social network
forage_dolphins <- read.table("mammalia-dolphin-florida-forage.edges")
# Social dolphins social network
social_dolphins <- read.table("mammalia-dolphin-florida-social.edges")
# Travel dolphins social network
travel_dolphins <- read.table("mammalia-dolphin-floridatravel.edges")
# Create a new dataset where we can identify all of the different relations among delphins
forage_dolphins$type <- "F"
social_dolphins$type <- "S"
travel_dolphins$type <- "T"
overall_dolphins$type <- "O"
overall_dolphins_label_ <- rbind(overall_dolphins, forage_dolphins, social_dolphins, travel_dolphins)
overall_dolphins_label_$type <- as.factor(overall_dolphins_label_$type)
dolphins_label <- rbind(overall_dolphins, forage_dolphins, social_dolphins, travel_dolphins)
dolphins_label$type <- as.factor(dolphins_label$type)
df <- rename(df, new_name = old_name)
str(dolphins_label)
```


## Networks.
# Comprehensive Network.
```{r}
# Most important one
net_overall_dolphins_label <- graph_from_data_frame(overall_dolphins_label_, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types

### EVERYTHING ALL AT ONCE NETWORK ###
# CREATE characteristics of the vertices
sightings_per_dolphin_1 = group_by(overall_dolphins_label_, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 = group_by(overall_dolphins_label_, V2) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_1 = group_by(dolphins_label, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 = group_by(dolphins_label, V2) %>% summarise(sightings = sum(V3))

# Merge the datasets based on the "name" column
merged_data <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
merged_data$sightings.y[is.na(merged_data$sightings.y)] <- 0
# Create a new column with the sum of occurrences
merged_data$sightings_per_dolphin <- merged_data$sightings.x + merged_data$sightings.y
head(merged_data)

# Remove unnecessary columns
merged_data <- select(merged_data, V1, sightings_per_dolphin)

V(net_overall_dolphins_label)$sightings_per_dolphin = merged_data$sightings_per_dolphin
net_overall_dolphins_label

# Create our network
net_dolphins_label <- graph_from_data_frame(dolphins_label, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types

# Add the sightings column to the network
V(net_dolphins_label)$sightings_per_dolphin = merged_data$sightings
```

# Forage Network
```{r}
# CREATE characteristics of the vertices
# CREATE characteristics of the vertices
dolphins_label_F <- dolphins_label[dolphins_label$type == "F",]
sightings_per_dolphin_1 <- group_by(dolphins_label_F, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 <- group_by(dolphins_label_F, V2) %>% summarise(sightings = sum(V3))

# Merge the datasets based on the "name" column
merged_data_F <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
tail(merged_data_F)

# Replace missing values with 0
merged_data_F$sightings.x[is.na(merged_data_F$sightings.x)] <- 0
merged_data_F$sightings.y[is.na(merged_data_F$sightings.y)] <- 0

# Create a new column with the sum of occurrences
merged_data_F$sightings <- merged_data_F$sightings.x + merged_data_F$sightings.y
head(merged_data_F)

# Remove unnecessary columns
merged_data_F <- select(merged_data_F, V1, sightings)

# Create our network
net_dolphins_label_F <- graph_from_data_frame(dolphins_label_F, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types
# Add the sightings column to the network
V(net_dolphins_label_F)$sightings_per_dolphin <- merged_data_F$sightings
```

# Travel Network.
```{r}
# CREATE characteristics of the vertices
dolphins_label_T <- dolphins_label[dolphins_label$type == "T",]
sightings_per_dolphin_1 <- group_by(dolphins_label_T, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 <- group_by(dolphins_label_T, V2) %>% summarise(sightings = sum(V3))

# Merge the datasets based on the "name" column
merged_data_T <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
head(merged_data_T)

# Replace missing values with 0
merged_data_T$sightings.x[is.na(merged_data_T$sightings.x)] <- 0
merged_data_T$sightings.y[is.na(merged_data_T$sightings.y)] <- 0

# Create a new column with the sum of occurrences
merged_data_T$sightings_per_dolphin <- merged_data_T$sightings.x + merged_data_T$sightings.y
head(merged_data_T)

# Remove unnecessary columns
merged_data_T <- select(merged_data_T, V1, sightings_per_dolphin)
head(merged_data_T)
# Create our network
net_dolphins_label_T <- graph_from_data_frame(dolphins_label_T, directed = FALSE) 

# Add the sightings column to the network vertices
V(net_dolphins_label_T)$sightings_per_dolphin <- merged_data_T$sightings
```

# Social Network.
```{r}
# CREATE characteristics of the vertices
dolphins_label_S <- dolphins_label[dolphins_label$type == "S",]
sightings_per_dolphin_1 <- group_by(dolphins_label_S, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 <- group_by(dolphins_label_S, V2) %>% summarise(sightings = sum(V3))

# Merge the datasets based on the "name" column
merged_data_S <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
tail(merged_data_S)

# Replace missing values with 0
merged_data_S$sightings.x[is.na(merged_data_S$sightings.x)] <- 0
merged_data_S$sightings.y[is.na(merged_data_S$sightings.y)] <- 0

# Create a new column with the sum of occurrences
merged_data_S$sightings <- merged_data_S$sightings.x + merged_data_S$sightings.y
head(merged_data_S)

# Remove unnecessary columns
merged_data_S <- select(merged_data_S, V1, sightings)

# Create our network
net_dolphins_label_S <- graph_from_data_frame(dolphins_label_S, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types
# Add the sightings column to the network
V(net_dolphins_label_S)$sightings_per_dolphin <- merged_data_S$sightings
```

# Overall Network.
```{r}
# CREATE characteristics of the vertices
dolphins_label_O <- dolphins_label[dolphins_label$type == "O",]
sightings_per_dolphin_1 <- group_by(dolphins_label_O, V1) %>% summarise(sightings = sum(V3))
sightings_per_dolphin_2 <- group_by(dolphins_label_O, V2) %>% summarise(sightings = sum(V3))

# Merge the datasets based on the "name" column
merged_data_O <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
head(merged_data_O)
# Replace missing values with 0
merged_data_O$sightings.x[is.na(merged_data_O$sightings.x)] <- 0
merged_data_O$sightings.y[is.na(merged_data_O$sightings.y)] <- 0

# Create a new column with the sum of occurrences
merged_data_O$sightings <- merged_data_O$sightings.x + merged_data_O$sightings.y
head(merged_data_O)

# Remove unnecessary columns
merged_data_O <- select(merged_data_O, V1, sightings)

# Create our network
net_dolphins_label_O <- graph_from_data_frame(dolphins_label_O, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types
# Add the sightings column to the network
V(net_dolphins_label_O)$sightings_per_dolphin <- merged_data_O$sightings
```




# Graphical representation of each Network.
```{r}
ggraph(net_dolphins_label_S, layout = "fr") + 
  geom_edge_link(aes(edge_alpha = after_stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(size = sightings_per_dolphin, color = sightings_per_dolphin)) + 
  theme_void() + 
  ggtitle("Social Network")

ggraph(net_dolphins_label_T, layout = "fr") + 
  geom_edge_link(aes(edge_alpha = after_stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(size = sightings_per_dolphin, color = sightings_per_dolphin)) + 
  theme_void() + 
  ggtitle("Travel Network")

ggraph(net_dolphins_label_F, layout = "fr") + 
  geom_edge_link(aes(edge_alpha = after_stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(size = sightings_per_dolphin, color = sightings_per_dolphin)) + 
  theme_void() + 
  ggtitle("Forage Network")

ggraph(net_dolphins_label_O, layout = "fr") + 
  geom_edge_link(aes(edge_alpha = after_stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(size = sightings_per_dolphin, color = sightings_per_dolphin)) + 
  theme_void() + 
  ggtitle("Overall Network")

ggraph(net_overall_dolphins_label, layout = "fr") + 
  geom_edge_link(aes(edge_alpha = after_stat(index)), show.legend = FALSE) + 
  geom_node_point(aes(size = sightings_per_dolphin, color = sightings_per_dolphin)) + 
  theme_void() + 
  ggtitle("Comprehensive Network")
```

Datasets have been succesfully imported, the corresponding networks were created and their graphical representations were provided. In particular, we created a *sighting_per_dolphin* variable to characterise each node (= distinct dolphin) according to the number of times that dolphin was registered in any sighting.

Now, we move on to graphically represent the findings of the research study, and additional insights we may find interesting to furtherly analyse.


## Research study.

# Methodology.

To understand dolphin social networks, researchers used various metrics that describe how dolphins interact. These metrics are important because they help explain behaviors like socializing, traveling, and foraging.

* *Network Metrics*: Different measures help describe the network's structure and each dolphin's role in it. These metrics are biologically significant as they reveal insights into dolphin behaviors.

* *Preferential Associations*: Researchers test if dolphins prefer certain companions. Using a software tool, they compare the real network to thousands of random networks. If dolphins show non-random associations, this suggests they have preferred companions.

* *Randomization Test*: To see if the network's structure is special, they compare it to many random networks. If the real network is different from the random ones, it indicates significant structure.

* *Group Size Comparison*: Using a statistical test (Mann–Whitney U-test), researchers compare group sizes across different networks to see if there's any significant difference in how dolphins group in different contexts.


# Research Findings + Graphical Representation

Here we report the research study findings, we explain what does it mean in terms of graph construction and then proceed to propose the appropriate graphs.

##### Aggiungi Table2 e Table3

* There are preferential associations between individuals in the overall network, the socialize network and the travel network, but not in the forage network (table 2). This is not an artefact of sample size: the number of sightings in the forage network (153) is greater than that in the travel network (77) and socialize network (38).
  + An higher *Clustering level* would indicate an increase in the preferential association behaviour in a network.

```{r}

```

**Socialise network** 
* Individuals have strong and repeated connections to many other individuals.
  + Highest average degree, Highest average strength, Highest average edge weight.
NB: strength of a vertex is the sum of the weights of the edges incident on it.
```{r}
# Calculate average degree for each network
avg_degree_social <- mean(degree(net_social))
avg_degree_forage <- mean(degree(net_forage))

# Create a data frame for plotting
data <- data.frame(Network = c("net_social", "net_forage"),
                   Avg_Degree = c(avg_degree_social, avg_degree_forage))

# Plot using ggraph
g <- ggplot(data, aes(x = Network, y = Avg_Degree, fill = Network)) +
  geom_col() +
  geom_text(aes(label = round(Avg_Degree, 2)), vjust = -0.5) +
  labs(title = "Average Degree Comparison",
       x = "Network",
       y = "Average Degree") +
  theme_minimal()
print(g)

avg_strength_social <- mean(strength(net_social))
avg_strength_forage <- mean(strength(net_forage))


# Create a data frame for plotting
data <- data.frame(Network = c("net_social", "net_forage"),
                   Avg_Strength = c(avg_strength_social, avg_strength_forage))

# Plot using ggraph
g <- ggplot(data, aes(x = Network, y = Avg_Strength, fill = Network)) +
  geom_col() +
  geom_text(aes(label = round(Avg_Strength, 2)), vjust = -0.5) +
  labs(title = "Average Degree Comparison",
       x = "Network",
       y = "Average Strength") +
  theme_minimal()
print(g)



# HWI = x / (x + 1/2(ya + yb)
# x: sighting delledge tra A e B
# ya: sighting di A senza B (sightingA - together)
# yb: sighting di B senza A (sightingB - together)

sightings_per_dolphin <- as.numeric(V(net_social)$sightings_per_dolphin)
names(sightings_per_dolphin) <- V(net_social)$name

# Define the HWI calculation function
calculate_hwi <- function(edge_id, net_social, sightings_per_dolphin) {
  # Get the vertices connected by the edge
  vertices <- ends(net_social, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together
  together <- E(net_social)$sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate HWI for each edge
hwi_values_S <- sapply(1:ecount(net_social), function(edge_id) {
  calculate_hwi(edge_id, net_social, sightings_per_dolphin)
})

# Add HWI as an edge attribute
E(net_social)$HWI <- hwi_values_S

# Print the edge attributes to verify
print(E(net_social))
average_hwi_S <- mean(hwi_values_S)
average_hwi_S


#######################################################overall
# Ensure that 'sightings_per_dolphin' is named vector and convert it to numeric if necessary
sightings_per_dolphin <- as.numeric(V(net_overall)$sightings_per_dolphin)
names(sightings_per_dolphin) <- V(net_overall)$name

# Define the function with added debug prints
calculate_hwi <- function(edge_id, net_overall, sightings_per_dolphin) {
  # Get the vertices connected by the edge
  vertices <- ends(net_overall, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together
  together <- E(net_overall)$sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate HWI for each edge
hwi_values_O <- sapply(1:ecount(net_overall), function(edge_id) {
  calculate_hwi(edge_id, net_overall, sightings_per_dolphin)
})

# Add HWI as an edge attribute
E(net_overall)$HWI <- hwi_values_O

# Compute the average HWI excluding NA values
average_hwi_O <- mean(hwi_values_O, na.rm = TRUE)
average_hwi_O

#######################################################travel
sightings_per_dolphin <- as.numeric(V(net_travel)$sightings_per_dolphin)
names(sightings_per_dolphin) <- V(net_travel)$name

# Define the function with added debug prints
calculate_hwi <- function(edge_id, net_travel, sightings_per_dolphin) {
  # Get the vertices connected by the edge
  vertices <- ends(net_travel, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together
  together <- E(net_travel)$sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate HWI for each edge
hwi_values_T <- sapply(1:ecount(net_travel), function(edge_id) {
  calculate_hwi(edge_id, net_travel, sightings_per_dolphin)
})

# Add HWI as an edge attribute
E(net_travel)$HWI <- hwi_values_T

# Compute the average HWI excluding NA values
average_hwi_T <- mean(hwi_values_T, na.rm = TRUE)
average_hwi_T

#######################################################Forage
sightings_per_dolphin <- as.numeric(V(net_forage)$sightings_per_dolphin)
names(sightings_per_dolphin) <- V(net_forage)$name

# Define the function with added debug prints
calculate_hwi <- function(edge_id, net_forage, sightings_per_dolphin) {
  # Get the vertices connected by the edge
  vertices <- ends(net_forage, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together
  together <- E(net_forage)$sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate HWI for each edge
hwi_values_F <- sapply(1:ecount(net_forage), function(edge_id) {
  calculate_hwi(edge_id, net_forage, sightings_per_dolphin)
})

# Add HWI as an edge attribute
E(net_forage)$HWI <- hwi_values_F

# Compute the average HWI excluding NA values
average_hwi_F <- mean(hwi_values_F, na.rm = TRUE)
average_hwi_F


# Create a vector of average HWI values
average_hwis <- c(average_hwi_O, average_hwi_F, average_hwi_T, average_hwi_S)

# Create a data frame with network names and average HWI values
hwis_data <- data.frame(Network = c("Overall", "Forage", "Travel", "Social"),
                        Avg_HWI = average_hwis)

# Plotting
g_hwis <- ggplot(hwis_data, aes(x = Network, y = Avg_HWI, fill = Network)) +
  geom_col() +
  geom_text(aes(label = round(Avg_HWI, 2)), vjust = -0.5) +
  labs(title = "Average HWI Values for Different Networks",
       x = "Network",
       y = "Average HWI") +
  theme_minimal()

print(g_hwis)







########fantasia!! aggiusto in base alla grandezza del sample!!
# Function to calculate HWI for a given edge considering weighted sightings
calculate_hwi_weighted <- function(edge_id, net_social, avg_sightings) {
  # Get the vertices connected by the edge
  vertices <- ends(net_social, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together (using the average sightings)
  together <- avg_sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate average HWI considering weighted sightings for net_social
calculate_average_hwi_social <- function(net_social, avg_sightings) {
  # Calculate HWI for each edge
  hwi_values <- sapply(1:ecount(net_social), function(edge_id) {
    calculate_hwi_weighted(edge_id, net_social, avg_sightings)
  })
  
  # Return the average HWI
  return(mean(hwi_values, na.rm = TRUE))
}

# Calculate the average sightings for each edge
avg_sightings <- sapply(1:ecount(net_social), function(edge_id) {
  mean(c(E(net_social)$sightings[edge_id], E(net_forage)$sightings[edge_id]))
})

# Calculate the average HWI for net_social considering weighted sightings
average_hwi_S <- calculate_average_hwi_social(net_social, avg_sightings)




# Function to calculate HWI for a given edge considering weighted sightings
calculate_hwi_weighted <- function(edge_id, net_overall, avg_sightings) {
  # Get the vertices connected by the edge
  vertices <- ends(net_overall, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together (using the average sightings)
  together <- avg_sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate average HWI considering weighted sightings for net_overall
calculate_average_hwi_overall <- function(net_overall, avg_sightings) {
  # Calculate HWI for each edge
  hwi_values <- sapply(1:ecount(net_overall), function(edge_id) {
    calculate_hwi_weighted(edge_id, net_overall, avg_sightings)
  })
  
  # Return the average HWI
  return(mean(hwi_values, na.rm = TRUE))
}

# Calculate the average HWI for net_overall considering weighted sightings
average_hwi_O <- calculate_average_hwi_overall(net_overall, avg_sightings)
average_hwi_O



# Function to calculate HWI for a given edge considering weighted sightings
calculate_hwi_weighted <- function(edge_id, net_forage, avg_sightings) {
  # Get the vertices connected by the edge
  vertices <- ends(net_forage, edge_id)
  vertex1 <- vertices[1]
  vertex2 <- vertices[2]
  
  # Number of times dolphins A and B were seen together (using the average sightings)
  together <- avg_sightings[edge_id]
  
  # Number of times A was seen without B
  sightings_A <- sightings_per_dolphin[vertex1]
  without_B <- sightings_A - together
  
  # Number of times B was seen without A
  sightings_B <- sightings_per_dolphin[vertex2]
  without_A <- sightings_B - together
  
  # Calculate HWI
  hwi_value <- together / (together + (without_A / 2) + (without_B / 2))
  
  return(hwi_value)
}

# Calculate average HWI considering weighted sightings for net_forage
calculate_average_hwi_forage <- function(net_forage, avg_sightings) {
  # Calculate HWI for each edge
  hwi_values <- sapply(1:ecount(net_forage), function(edge_id) {
    calculate_hwi_weighted(edge_id, net_forage, avg_sightings)
  })
  
  # Return the average HWI
  return(mean(hwi_values, na.rm = TRUE))
}

# Calculate the average HWI for net_forage considering weighted sightings
average_hwi_F <- calculate_average_hwi_forage(net_forage, avg_sightings)
average_hwi_F
```


* Socializing happens in large groups and these groups are not exclusive.
  + Largest group size per sighting, Highest size per community, Least number of communities, Fewest connected components.
  

* Dolphins that are connected to a particular dolphin are more likely to be connected to one another.
  + Highest clustering coefficient.

**Travel network**
* Dolphins in this network do not have strong and repeated connections to many others except their preferential associates   + Lower average degree, Lower average strength, Lower average edge weight).

* Travelling happens in smaller groups than socializing.
  + Smaller group sizes per sighting, Smaller community size, Larger number of communities, Larger number of connected components. 
  
* Dolphins that are connected to a particular dolphin are less likely to be connected to each other.
  + Smaller clustering coefficient.

* Though dolphins do have preferential associations while travelling, they do not travel in groups as large as those they socialize in or as small as they forage in.

**Forage network**
* The dolphins in the forage network have the weakest and least repeated connections to other individuals.
  + Lower average degree, Lower average strength, Lowest average edge weight). 

* Foraging happens in smaller groups than any other activity and these groups are exclusive with fewer links to other foraging groups or they are more likely in groups that never forage together. 
  + Smallest group sizes per sighting, Smallest community size; Highest number of communities or Highest number of connected components.
  
* Foraging dolphins that are connected to other foraging dolphins are not as likely to be connected to each other as they are in the socialize and forage networks.
  + Lowest clustering coefficient)
  
**Community Overlap**
### AGGIUNGI TABLE4
A large community overlap between two networks means dolphins that tend to associate closely with each other in one network also associate closely in the other. * The socialize network and the travel network have the most substantial community structure overlap, the travel network and the forage network have the least and the socialize network and the forage network have an intermediate value. The overlap between the overall network and each activity network is less than that of the activity networks to each other.

# Data preprocessing and network creation


```{r networks}
# Function to create a network whatever the dataset
dolphins_label_F <- rename(dolphins_label_F, sightings = V3)
dolphins_label_S <- rename(dolphins_label_S, sightings = V3)
dolphins_label_T <- rename(dolphins_label_T, sightings = V3)
dolphins_label_O <- rename(dolphins_label_O, sightings = V3)
net_dolphins = function(df){

  sightings_per_dolphin_1 = group_by(df, V1) %>% summarise(sightings = sum(sightings))
  sightings_per_dolphin_2 = group_by(df, V2) %>% summarise(sightings = sum(sightings))

  # Merge the datasets based on the "name" column
  merged_data <- merge(sightings_per_dolphin_1, sightings_per_dolphin_2, by.x = "V1", by.y = "V2", all = TRUE)
  head(merged_data)
  # Replace missing values with 0
  merged_data$sightings.x[is.na(merged_data$sightings.x)] <- 0
  merged_data$sightings.y[is.na(merged_data$sightings.y)] <- 0

  # Create a new column with the sum of occurrences
  merged_data$sightings <- merged_data$sightings.x + merged_data$sightings.y
  head(merged_data)

  # Remove unnecessary columns
  merged_data <- select(merged_data, V1, sightings)

  # Create our network
  net_dolphins_label <- graph_from_data_frame(df, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types
  # Add the sightings column to the network
  names_net <- as.numeric(V(net_dolphins_label)$name)
  merged_data = merged_data[order(match(merged_data$V1, names_net)),]
  net_dolphins_label=set_vertex_attr(net_dolphins_label, "sightings_per_dolphin", index = V(net_dolphins_label), merged_data$sightings)
  return(net_dolphins_label)
} 

dolphins_label_F = dolphins_label[dolphins_label$type == "F",]
dolphins_label_S = dolphins_label[dolphins_label$type == "S",]
dolphins_label_T = dolphins_label[dolphins_label$type == "T",]
dolphins_label_O = dolphins_label[dolphins_label$type == "O",]


net_forage = net_dolphins(dolphins_label_F)
net_social = net_dolphins(dolphins_label_S)
net_travel = net_dolphins(dolphins_label_T)
net_overall = net_dolphins(dolphins_label_O)
net = net_dolphins(dolphins_label)
```

## Plots.
```{r networks}
# Suggested colors for edge categories and node gradient
edge_colors <- c("1" = "#377eb8", "2" = "#e41a1c", "3-4" = "#4daf4a", ">4" = "#984ea3")
node_gradient <- c("#f7fbff", "#08306b")  # From light blue to dark blue
edge_colors_general <- c("F" = "#377eb8", "S" = "#e41a1c", "T" = "#4daf4a", "O" = "#984ea3")

# Plot the network
ggraph(net_overall, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = sightings), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() +
  theme(legend.position = "bottom")
#### il fatto che tutti i sightings siano 1 è ok?

ggraph(net_social, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors_general) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() + theme(legend.position = "bottom")

ggraph(net_travel, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors_general) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() + theme(legend.position = "bottom")

ggraph(net_forage, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors_general) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() + theme(legend.position = "bottom")

ggraph(net_overall, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors_general) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() + theme(legend.position = "bottom")

ggraph(net, layout = "stress", bbox = 15) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors_general) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() + theme(legend.position = "bottom")
```


```{r networks}
############################################################################################################################################################################
### LINE GRAPH ###
# Create the line graph
prova= dolphins_label[, c(1,2,4)]
net_prova = graph_from_data_frame(dolphins_label, directed = FALSE)
line_graph <- make_line_graph(net_prova)
str(line_graph)


# Plot the line graph using ggraph
ggraph(line_graph, layout = "stress") +
  geom_edge_link(aes(edge_alpha = 0.8), edge_colour = "blue") +
  geom_node_point(size = 5, color = "red") + 
  theme_void() +
  theme(legend.position = "none")
```


```{r networks}
############################################################################################################################################################################
### Nicer plots ###

######## CLUSTERING ########
#### NODE CLUSTERING ####

comps <- components(net_dolphins_label_F)
net_dolphins_label_F_restricted <- delete_vertices(net_dolphins_label_F, which(comps$membership == which.min(comps$csize)))

comps <- components(net_dolphins_label_F_restricted)
net_dolphins_label_F_restricted <- delete_vertices(net_dolphins_label_F_restricted, which(comps$membership == which.min(comps$csize)))

comps <- components(net_dolphins_label_F_restricted)
net_dolphins_label_F_restricted <- delete_vertices(net_dolphins_label_F_restricted, which(comps$membership == which.min(comps$csize)))


bb <- layout_as_backbone(line_graph, keep = 0.4)
#### ERRORE
E(net_dolphins_label_F_restricted)$col <- F

E(net_dolphins_label_F_restricted)$col[bb$backbone] <- T

ggraph(net_dolphins_label_F_restricted,
       layout = "manual",
       x = bb$xy[, 1],
       y = bb$xy[, 2]) +
  geom_edge_link0(aes(filter = !col, col = col), width = 0.2) +
  geom_node_voronoi(
    aes(x, y, fill = sightings_per_dolphin),
    max.radius = 0.4,
    expand = unit(-0.5, 'mm'),
    colour = 'black'
  ) +
  scale_color_brewer(palette = "Set1") +
  #scale_fill_brewer(palette = "Set1") +
  scale_edge_color_manual(values = c(rgb(0, 0, 0, 0.3), rgb(0, 0, 0, 1))) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank()
  ) +
  theme_graph() +
  theme(legend.position = "none")

ggraph(net_dolphins_label_O_restricted,
       layout = "manual",
       x = bb$xy[, 1],
       y = bb$xy[, 2]) +
  geom_edge_link0(aes(col = col), width = 0.2) +
  geom_node_point(aes(fill = sightings_per_dolphin), shape = 21, size = 3) +
  geom_mark_hull(
    aes(x, y, group = sightings_per_dolphin, fill = sightings_per_dolphin),
    concavity = 4,
    expand = unit(2, "mm"),
    alpha = 0.25
  ) +
  scale_color_brewer(palette = "Set1") +
  #scale_fill_brewer(palette = "Set1") +
  scale_edge_color_manual(values = c(rgb(0, 0, 0, 0.3), rgb(0, 0, 0, 1))) +
  theme_graph()+
  theme(legend.position = "none")

###### EDGE CLUSTERING ######

num_edges <- ecount(net_dolphins_label_F)
print(paste("Number of edges:", num_edges))


net_dolphins_label_F_cluster <- cluster_edge_betweenness(net_dolphins_label_F)
# Get the membership of each edge
plot(net_dolphins_label_F_cluster, net_dolphins_label_F, layout=layout_with_fr(net_dolphins_label_F))

edge_membership <- membership(net_dolphins_label_F_cluster)
E(net_dolphins_label_F)$cluster <- edge_membership
sum(edge_membership)
ggraph(net_dolphins_label_F, layout = "fr") +
  geom_edge_link(aes(colour = factor(edge_membership)), edge_width = 0.5) +
  geom_node_point(size = 5) +
  scale_edge_colour_manual(values = rainbow(length(unique(edge_membership)))) +
  theme_graph() +
  theme(legend.position = "bottom")



# Plot the graph with ggraph
ggraph(net_dolphins_label_F, layout = "stress") +
  geom_edge_link(aes(colour = factor(cluster)), width = 0.5) +
  geom_node_point(size = 5) +
  scale_edge_colour_manual(values = rainbow(length(unique(edge_membership)))) +
  theme_graph() +
  theme(legend.position = "bottom")


## SHIT METHOD ##
forage_dolphins$type <- "F"
social_dolphins$type <- "S"
travel_dolphins$type <- "T"
dolphins_label_prova <- rbind(forage_dolphins, social_dolphins, travel_dolphins)
dolphins_label_prova$type <- as.factor(dolphins_label_prova$type)
net_prova <- graph_from_data_frame(dolphins_label_prova, directed = FALSE) #from the first 250 rows of the combined data frame with labeled interaction types

edge_clusters <- cluster_spinglass(net_prova, weights = E(net_prova)$type)

# Assign cluster membership as an edge attribute
E(net_prova)$cluster <- membership(edge_clusters)

# Get a layout for the network
layout <- layout_with_fr(net_prova)

# Plot the network clustered by edges
ggraph(net_prova, layout = "manual", x = layout[, 1], y = layout[, 2]) +
  geom_edge_link(aes(colour = factor(cluster)), edge_width = 0.5) +
  geom_node_point(aes(fill = sightings_per_dolphin), shape = 21, size = 3) +
  scale_fill_gradient(low = "blue", high = "red") +
  scale_edge_colour_brewer(palette = "Set1") +
  theme_graph() +
  theme(legend.position = "bottom")

############################################################################################################################################################################

### ORGANIZED ###
ggraph(net_dolphins_label_O, layout = "centrality", cent = graph.strength(net_dolphins_label_O)) +
  geom_edge_link2(aes(edge_colour = type), edge_linewidth = 0.5) +
  geom_node_point(aes(fill= sightings_per_dolphin), shape = 21, size = 3) +
  geom_node_text(aes(label = name, size = igraph::degree(net_dolphins_label_O)),
    family = "serif", repel = TRUE
  ) +
  scale_edge_colour_brewer(palette = "Set1") +
  #scale_fill_manual(values = c("grey66", "#EEB422", "#424242")) +
  scale_size(range = c(4, 10), guide = "none") +
  theme_graph() +
  theme(legend.position = "bottom")

ggraph(net_dolphins_label, layout = "centrality", cent = graph.strength(gotS1)) +
  geom_edge_link0(aes(edge_linewidth = weight), edge_colour = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(size = size, label = name), family = "serif") +
  scale_edge_width_continuous(range = c(0.2, 0.9)) +
  scale_size_continuous(range = c(1, 8)) +
  scale_fill_manual(values = got_palette) +
  coord_fixed() +
  theme_graph() +
  theme(legend.position = "none")

### CONCENTRIC LAYOUT ###

ggraph(gotS1, layout = "focus", focus = 1) +
  geom_edge_link0(aes(edge_linewidth = weight), edge_colour = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(filter = (name == "Ned"), size = size, label = name),
    family = "serif"
  ) +
  scale_edge_width_continuous(range = c(0.2, 1.2)) +
  scale_size_continuous(range = c(1, 5)) +
  scale_fill_manual(values = got_palette) +
  coord_fixed() +
  theme_graph() +
  theme(legend.position = "none")

############################################################################################################################################################################
### CIRCULAR LAYOUT ###


comps <- components(net_overall)
net_O_restricted <- delete_vertices(net_overall, which(comps$membership == which.min(comps$csize)))

comps <- components(net_O_restricted)
net_O_restricted <- delete_vertices(net_O_restricted, which(comps$membership == which.min(comps$csize)))



ggraph(net_O_restricted, layout = "centrality", cent = graph.strength(net_O_restricted)) +
  geom_edge_link2(aes(edge_colour = sightings), edge_linewidth = 0.5) +
  scale_edge_colour_manual(values = edge_colors) + 
  geom_node_point(aes(fill = sightings_per_dolphin, size = sightings_per_dolphin), shape=21) +
  scale_fill_gradient(low = node_gradient[1], high = node_gradient[2]) + 
  geom_node_text(aes(label = name), vjust = 0.5, hjust = 0.5,
                 family = "serif", size = 3) +  # Adjust font size as needed
  scale_size(range = c(4, 10), guide = "none") +
  coord_fixed() +
  theme_graph() +
  theme(legend.position = "bottom")

ggraph(gotS1, layout = "centrality", cent = graph.strength(gotS1)) +
  geom_edge_link0(aes(edge_linewidth = weight), edge_colour = "grey66") +
  geom_node_point(aes(fill = clu, size = size), shape = 21) +
  geom_node_text(aes(size = size, label = name), family = "serif") +
  scale_edge_width_continuous(range = c(0.2, 0.9)) +
  scale_size_continuous(range = c(1, 8)) +
  scale_fill_manual(values = got_palette) +
  coord_fixed() +
  theme_graph() +
  theme(legend.position = "none")
```





